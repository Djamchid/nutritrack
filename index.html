<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriTrack - Suivi Nutrition</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="NutriTrack">
    
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NutriTrack">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- SEO -->
    <meta name="description" content="Suivez facilement vos macronutriments et micronutriments. Application 100% offline pour un suivi nutritionnel simple et efficace.">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 25px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            color: var(--white);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--white);
            color: var(--primary);
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .date-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .date-btn {
            padding: 8px 16px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }

        .date-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .date-display {
            font-size: 20px;
            font-weight: 600;
            padding: 8px 16px;
            background: var(--light);
            border-radius: 8px;
            min-width: 200px;
            text-align: center;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, var(--light) 0%, var(--white) 100%);
            padding: 20px;
            border-radius: var(--radius);
            border: 1px solid #e5e7eb;
            transition: var(--transition);
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .kpi-title {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 10px;
            background: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            border-radius: 5px;
            transition: width 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .macro-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
            font-size: 16px;
        }

        input[type="number"] {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--secondary) 0%, #d97706 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
        }

        .preset-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .micro-section {
            margin-bottom: 30px;
        }

        .micro-group {
            background: var(--light);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 15px;
        }

        .micro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .micro-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .micro-badge {
            padding: 4px 12px;
            background: var(--primary);
            color: var(--white);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .checkbox-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .checkbox-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            width: 44px;
            height: 44px;
        }

        .checkbox-custom {
            width: 44px;
            height: 44px;
            border: 3px solid #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white);
            transition: var(--transition);
            cursor: pointer;
        }

        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom {
            background: var(--success);
            border-color: var(--success);
            animation: checkPop 0.3s ease-out;
        }

        @keyframes checkPop {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .checkbox-custom::after {
            content: '‚úì';
            color: var(--white);
            font-size: 24px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-custom::after {
            opacity: 1;
        }

        .fish-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 30px;
        }

        .settings-section {
            display: grid;
            gap: 30px;
        }

        .settings-group {
            background: var(--light);
            padding: 25px;
            border-radius: var(--radius);
        }

        .settings-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .week-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .day-card {
            background: var(--white);
            border: 2px solid #e5e7eb;
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
        }

        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .day-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .macro-badges {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 12px;
            background: var(--light);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
        }

        .badge-p .badge-icon {
            background: #ef4444;
        }

        .badge-c .badge-icon {
            background: #f59e0b;
        }

        .badge-f .badge-icon {
            background: #10b981;
        }

        .import-export {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .file-input {
            display: none;
        }

        .file-label {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: var(--white);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-block;
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .week-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .kpi-value {
                font-size: 24px;
            }
            
            .week-view {
                grid-template-columns: 1fr;
            }
        }

        .help-text {
            font-size: 14px;
            color: var(--gray);
            margin-top: 5px;
        }

        .edit-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            display: inline-block;
            margin-top: 10px;
            transition: var(--transition);
        }

        .edit-link:hover {
            color: var(--primary-dark);
            transform: translateX(5px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <div class="logo">ü•ó</div>
                NutriTrack
            </h1>
            <nav>
                <button class="nav-btn active" onclick="showTab('day')">Jour</button>
                <button class="nav-btn" onclick="showTab('week')">Semaine</button>
                <button class="nav-btn" onclick="showTab('settings')">Param√®tres</button>
            </nav>
        </header>

        <div class="content">
            <!-- Tab Jour -->
            <div id="day-tab" class="tab-content active">
                <div class="date-navigation">
                    <button class="date-btn" onclick="previousDay()">‚Üê Pr√©c√©dent</button>
                    <div class="date-display" id="current-date">Aujourd'hui</div>
                    <button class="date-btn" onclick="nextDay()">Suivant ‚Üí</button>
                    <button class="date-btn" onclick="goToToday()">Aujourd'hui</button>
                </div>

                <div class="kpi-container">
                    <div class="kpi-card">
                        <div class="kpi-title">Calories</div>
                        <div class="kpi-value" id="calories-display">0 kcal</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="calories-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Prot√©ines</div>
                        <div class="kpi-value" id="protein-display">0 g</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="protein-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Glucides</div>
                        <div class="kpi-value" id="carbs-display">0 g</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="carbs-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Lipides</div>
                        <div class="kpi-value" id="fat-display">0 g</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="fat-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="macro-inputs">
                    <div class="input-group">
                        <label for="protein-input">Prot√©ines (g)</label>
                        <input type="number" id="protein-input" min="0" onchange="saveMacros()" />
                    </div>
                    <div class="input-group">
                        <label for="carbs-input">Glucides (g)</label>
                        <input type="number" id="carbs-input" min="0" onchange="saveMacros()" />
                    </div>
                    <div class="input-group">
                        <label for="fat-input">Lipides (g)</label>
                        <input type="number" id="fat-input" min="0" onchange="saveMacros()" />
                    </div>
                    <div class="input-group">
                        <label for="extra-input">Calories extra</label>
                        <input type="number" id="extra-input" min="0" onchange="saveMacros()" />
                    </div>
                </div>

                <div class="preset-buttons">
                    <button class="preset-btn" onclick="addPreset('breakfast')">ü•ê Petit-d√©jeuner</button>
                    <button class="preset-btn" onclick="addPreset('lunch')">ü•ó D√©jeuner</button>
                    <button class="preset-btn" onclick="addPreset('dinner')">üçΩÔ∏è D√Æner</button>
                    <button class="preset-btn" onclick="addPreset('snack')">üçé Collation</button>
                </div>

                <div class="micro-section">
                    <h2 style="margin-bottom: 20px;">Micronutriments</h2>
                    
                    <div class="micro-group">
                        <div class="micro-header">
                            <span class="micro-title">üçì Fruits</span>
                            <span class="micro-badge" id="fruits-badge">0/2</span>
                        </div>
                        <div class="checkbox-container" id="fruits-checks"></div>
                    </div>

                    <div class="micro-group">
                        <div class="micro-header">
                            <span class="micro-title">ü•¶ L√©gumes</span>
                            <span class="micro-badge" id="veg-badge">0/3</span>
                        </div>
                        <div class="checkbox-container" id="veg-checks"></div>
                    </div>

                    <div class="micro-group">
                        <div class="micro-header">
                            <span class="micro-title">üåæ L√©gumineuses/C√©r√©ales compl√®tes</span>
                            <span class="micro-badge" id="legcere-badge">0/1</span>
                        </div>
                        <div class="checkbox-container" id="legcere-checks"></div>
                    </div>

                    <div class="micro-group">
                        <div class="micro-header">
                            <span class="micro-title">ü•õ Calcium</span>
                            <span class="micro-badge" id="calcium-badge">0/2</span>
                        </div>
                        <div class="checkbox-container" id="calcium-checks"></div>
                    </div>

                    <div class="micro-group">
                        <div class="micro-header">
                            <span class="micro-title">ü•ú Ol√©agineux/Graines</span>
                            <span class="micro-badge" id="nuts-badge">0/1</span>
                        </div>
                        <div class="checkbox-container" id="nuts-checks"></div>
                    </div>

                    <div class="micro-group">
                        <div class="micro-header">
                            <span class="micro-title">üíß Hydratation</span>
                            <span class="micro-badge" id="water-badge">0/8</span>
                        </div>
                        <div class="checkbox-container" id="water-checks"></div>
                    </div>
                </div>

                <div class="fish-section">
                    <h3 style="margin-bottom: 15px;">üêü Poissons gras (semaine)</h3>
                    <div class="checkbox-container" id="fish-checks"></div>
                </div>
            </div>

            <!-- Tab Semaine -->
            <div id="week-tab" class="tab-content">
                <div class="week-selector">
                    <label for="week-select" style="font-weight: 600;">Semaine commen√ßant le :</label>
                    <input type="date" id="week-select" onchange="loadWeekView()" style="padding: 8px; border-radius: 8px; border: 2px solid #e5e7eb;" />
                    <button class="date-btn" onclick="goToCurrentWeek()">Semaine actuelle</button>
                </div>

                <div class="week-view" id="week-view"></div>
            </div>

            <!-- Tab Param√®tres -->
            <div id="settings-tab" class="tab-content">
                <div class="settings-section">
                    <div class="settings-group">
                        <h2 class="settings-title">Objectifs Macronutriments</h2>
                        <div class="settings-grid">
                            <div class="input-group">
                                <label for="goal-cal">Calories (kcal)</label>
                                <input type="number" id="goal-cal" value="2100" min="0" />
                            </div>
                            <div class="input-group">
                                <label for="goal-p">Prot√©ines (g)</label>
                                <input type="number" id="goal-p" value="78" min="0" />
                                <div class="help-text">Recommand√© : 1.2 g/kg de poids</div>
                            </div>
                            <div class="input-group">
                                <label for="goal-c">Glucides (g)</label>
                                <input type="number" id="goal-c" value="240" min="0" />
                            </div>
                            <div class="input-group">
                                <label for="goal-f">Lipides (g)</label>
                                <input type="number" id="goal-f" value="70" min="0" />
                            </div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h2 class="settings-title">Objectifs Micronutriments (portions/jour)</h2>
                        <div class="settings-grid">
                            <div class="input-group">
                                <label for="goal-fruits">Fruits</label>
                                <input type="number" id="goal-fruits" value="2" min="0" />
                            </div>
                            <div class="input-group">
                                <label for="goal-veg">L√©gumes</label>
                                <input type="number" id="goal-veg" value="3" min="0" />
                            </div>
                            <div class="input-group">
                                <label for="goal-legcere">L√©gumineuses/C√©r√©ales</label>
                                <input type="number" id="goal-legcere" value="1" min="0" />
                            </div>
                            <div class="input-group">
                                <label for="goal-calcium">Calcium</label>
                                <input type="number" id="goal-calcium" value="2" min="0" />
                            </div>
                            <div class="input-group">
                                <label for="goal-nuts">Ol√©agineux/Graines</label>
                                <input type="number" id="goal-nuts" value="1" min="0" />
                            </div>
                            <div class="input-group">
                                <label for="goal-water">Hydratation (verres)</label>
                                <input type="number" id="goal-water" value="8" min="0" />
                            </div>
                            <div class="input-group">
                                <label for="goal-fish">Poissons gras/semaine</label>
                                <input type="number" id="goal-fish" value="2" min="0" />
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn-primary" onclick="saveSettings()">üíæ Sauvegarder les objectifs</button>
                        <button class="btn-primary btn-danger" onclick="resetDay()">üóëÔ∏è R√©initialiser la journ√©e</button>
                    </div>

                    <div class="import-export">
                        <button class="btn-primary" onclick="exportData()">üì• Exporter les donn√©es</button>
                        <label for="import-file" class="file-label">üì§ Importer les donn√©es</label>
                        <input type="file" id="import-file" class="file-input" accept=".json" onchange="importData(event)" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const APP_KEY = 'nutriApp.v1';
        const PRESETS = {
            breakfast: { p: 15, c: 45, f: 12 },
            lunch: { p: 30, c: 60, f: 20 },
            dinner: { p: 25, c: 50, f: 18 },
            snack: { p: 8, c: 25, f: 8 }
        };

        // State
        let currentDate = new Date().toISOString().split('T')[0];
        let appState = loadState();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDay();
            renderMicroCheckboxes();
            renderFishCheckboxes();
            updateWeekSelector();
        });

        // State Management
        function getDefaultState() {
            return {
                goals: {
                    cal: 2100,
                    p: 78,
                    c: 240,
                    f: 70,
                    micro: {
                        fruits: 2,
                        veg: 3,
                        legcere: 1,
                        calcium: 2,
                        nuts: 1,
                        water: 8
                    },
                    fishPerWeek: 2
                },
                days: {},
                fish: {}
            };
        }

        function loadState() {
            const stored = localStorage.getItem(APP_KEY);
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
            return getDefaultState();
        }

        function saveState() {
            localStorage.setItem(APP_KEY, JSON.stringify(appState));
        }

        function getCurrentDayData() {
            return appState.days[currentDate] || {
                micro: { fruits: 0, veg: 0, legcere: 0, calcium: 0, nuts: 0, water: 0 },
                p: 0, c: 0, f: 0, extra: 0
            };
        }

        // Navigation
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${tab}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'week') {
                loadWeekView();
            } else if (tab === 'settings') {
                loadSettings();
            }
        }

        function previousDay() {
            const date = new Date(currentDate);
            date.setDate(date.getDate() - 1);
            currentDate = date.toISOString().split('T')[0];
            loadDay();
        }

        function nextDay() {
            const date = new Date(currentDate);
            date.setDate(date.getDate() + 1);
            currentDate = date.toISOString().split('T')[0];
            loadDay();
        }

        function goToToday() {
            currentDate = new Date().toISOString().split('T')[0];
            loadDay();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date().toISOString().split('T')[0];
            
            if (dateStr === today) return "Aujourd'hui";
            
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }

        // Day View
        function loadDay() {
            document.getElementById('current-date').textContent = formatDate(currentDate);
            
            const dayData = getCurrentDayData();
            
            // Load macros
            document.getElementById('protein-input').value = dayData.p || '';
            document.getElementById('carbs-input').value = dayData.c || '';
            document.getElementById('fat-input').value = dayData.f || '';
            document.getElementById('extra-input').value = dayData.extra || '';
            
            // Update displays
            updateMacroDisplays();
            
            // Load micro checkboxes
            loadMicroCheckboxes();
            
            // Load fish checkboxes
            loadFishCheckboxes();
        }

        function saveMacros() {
            const dayData = getCurrentDayData();
            
            dayData.p = parseFloat(document.getElementById('protein-input').value) || 0;
            dayData.c = parseFloat(document.getElementById('carbs-input').value) || 0;
            dayData.f = parseFloat(document.getElementById('fat-input').value) || 0;
            dayData.extra = parseFloat(document.getElementById('extra-input').value) || 0;
            
            appState.days[currentDate] = dayData;
            saveState();
            updateMacroDisplays();
        }

        function updateMacroDisplays() {
            const dayData = getCurrentDayData();
            const goals = appState.goals;
            
            // Calculate calories
            const calories = (dayData.p * 4) + (dayData.c * 4) + (dayData.f * 9) + dayData.extra;
            
            // Update displays
            document.getElementById('calories-display').textContent = `${Math.round(calories)} kcal`;
            document.getElementById('protein-display').textContent = `${dayData.p} g`;
            document.getElementById('carbs-display').textContent = `${dayData.c} g`;
            document.getElementById('fat-display').textContent = `${dayData.f} g`;
            
            // Update progress bars
            document.getElementById('calories-progress').style.width = `${Math.min(100, (calories / goals.cal) * 100)}%`;
            document.getElementById('protein-progress').style.width = `${Math.min(100, (dayData.p / goals.p) * 100)}%`;
            document.getElementById('carbs-progress').style.width = `${Math.min(100, (dayData.c / goals.c) * 100)}%`;
            document.getElementById('fat-progress').style.width = `${Math.min(100, (dayData.f / goals.f) * 100)}%`;
        }

        function addPreset(type) {
            const preset = PRESETS[type];
            const dayData = getCurrentDayData();
            
            dayData.p = (dayData.p || 0) + preset.p;
            dayData.c = (dayData.c || 0) + preset.c;
            dayData.f = (dayData.f || 0) + preset.f;
            
            appState.days[currentDate] = dayData;
            saveState();
            
            document.getElementById('protein-input').value = dayData.p;
            document.getElementById('carbs-input').value = dayData.c;
            document.getElementById('fat-input').value = dayData.f;
            
            updateMacroDisplays();
        }

        // Micronutrients
        function renderMicroCheckboxes() {
            const groups = ['fruits', 'veg', 'legcere', 'calcium', 'nuts', 'water'];
            
            groups.forEach(group => {
                const container = document.getElementById(`${group}-checks`);
                container.innerHTML = '';
                
                const count = appState.goals.micro[group];
                for (let i = 0; i < count; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'checkbox-wrapper';
                    
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = `${group}-${i}`;
                    input.onchange = () => saveMicroCheckbox(group, i);
                    
                    const label = document.createElement('label');
                    label.className = 'checkbox-custom';
                    label.htmlFor = `${group}-${i}`;
                    
                    wrapper.appendChild(input);
                    wrapper.appendChild(label);
                    container.appendChild(wrapper);
                }
            });
        }

        function loadMicroCheckboxes() {
            const dayData = getCurrentDayData();
            const groups = ['fruits', 'veg', 'legcere', 'calcium', 'nuts', 'water'];
            
            groups.forEach(group => {
                const count = dayData.micro[group] || 0;
                const max = appState.goals.micro[group];
                
                for (let i = 0; i < max; i++) {
                    const checkbox = document.getElementById(`${group}-${i}`);
                    if (checkbox) {
                        checkbox.checked = i < count;
                    }
                }
                
                // Update badge
                document.getElementById(`${group}-badge`).textContent = `${count}/${max}`;
            });
        }

        function saveMicroCheckbox(group, index) {
            const dayData = getCurrentDayData();
            if (!dayData.micro) dayData.micro = {};
            
            const max = appState.goals.micro[group];
            let count = 0;
            
            for (let i = 0; i < max; i++) {
                const checkbox = document.getElementById(`${group}-${i}`);
                if (checkbox && checkbox.checked) count++;
            }
            
            dayData.micro[group] = Math.min(count, max);
            appState.days[currentDate] = dayData;
            saveState();
            
            // Update badge
            document.getElementById(`${group}-badge`).textContent = `${count}/${max}`;
        }

        // Fish tracking
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            return d.toISOString().split('T')[0];
        }

        function renderFishCheckboxes() {
            const container = document.getElementById('fish-checks');
            container.innerHTML = '';
            
            const count = appState.goals.fishPerWeek;
            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'checkbox-wrapper';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `fish-${i}`;
                input.onchange = () => saveFishCheckbox(i);
                
                const label = document.createElement('label');
                label.className = 'checkbox-custom';
                label.htmlFor = `fish-${i}`;
                
                wrapper.appendChild(input);
                wrapper.appendChild(label);
                container.appendChild(wrapper);
            }
        }

        function loadFishCheckboxes() {
            const weekStart = getWeekStart(currentDate);
            const fishCount = appState.fish[weekStart] || 0;
            const max = appState.goals.fishPerWeek;
            
            for (let i = 0; i < max; i++) {
                const checkbox = document.getElementById(`fish-${i}`);
                if (checkbox) {
                    checkbox.checked = i < fishCount;
                }
            }
        }

        function saveFishCheckbox(index) {
            const weekStart = getWeekStart(currentDate);
            const max = appState.goals.fishPerWeek;
            let count = 0;
            
            for (let i = 0; i < max; i++) {
                const checkbox = document.getElementById(`fish-${i}`);
                if (checkbox && checkbox.checked) count++;
            }
            
            appState.fish[weekStart] = count;
            saveState();
        }

        // Week View
        function updateWeekSelector() {
            const weekStart = getWeekStart(new Date());
            document.getElementById('week-select').value = weekStart;
        }

        function goToCurrentWeek() {
            updateWeekSelector();
            loadWeekView();
        }

        function loadWeekView() {
            const weekSelect = document.getElementById('week-select');
            if (!weekSelect.value) {
                updateWeekSelector();
            }
            
            const startDate = new Date(weekSelect.value);
            const container = document.getElementById('week-view');
            container.innerHTML = '';
            
            const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const dayData = appState.days[dateStr] || { micro: {}, p: 0, c: 0, f: 0, extra: 0 };
                
                const calories = (dayData.p * 4) + (dayData.c * 4) + (dayData.f * 9) + dayData.extra;
                
                const card = document.createElement('div');
                card.className = 'day-card';
                
                card.innerHTML = `
                    <div class="day-header">${days[i]} ${date.getDate()}/${date.getMonth() + 1}</div>
                    <div class="kpi-value">${Math.round(calories)} kcal</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(100, (calories / appState.goals.cal) * 100)}%"></div>
                    </div>
                    <div class="macro-badges">
                        <div class="badge badge-p">
                            <span class="badge-icon"></span>
                            P: ${dayData.p}/${appState.goals.p}g
                        </div>
                        <div class="badge badge-c">
                            <span class="badge-icon"></span>
                            G: ${dayData.c}/${appState.goals.c}g
                        </div>
                        <div class="badge badge-f">
                            <span class="badge-icon"></span>
                            L: ${dayData.f}/${appState.goals.f}g
                        </div>
                    </div>
                    <div class="micro-badges">
                        ${Object.keys(appState.goals.micro).map(key => {
                            const value = dayData.micro[key] || 0;
                            const goal = appState.goals.micro[key];
                            const emoji = {
                                fruits: 'üçì',
                                veg: 'ü•¶',
                                legcere: 'üåæ',
                                calcium: 'ü•õ',
                                nuts: 'ü•ú',
                                water: 'üíß'
                            }[key];
                            return `<div class="badge">${emoji} ${value}/${goal}</div>`;
                        }).join('')}
                    </div>
                    <a href="#" class="edit-link" onclick="editDay('${dateStr}'); return false;">‚Üí √âditer</a>
                `;
                
                container.appendChild(card);
            }
        }

        function editDay(date) {
            currentDate = date;
            showTab('day');
            document.querySelector('.nav-btn').click();
            loadDay();
        }

        // Settings
        function loadSettings() {
            const goals = appState.goals;
            
            document.getElementById('goal-cal').value = goals.cal;
            document.getElementById('goal-p').value = goals.p;
            document.getElementById('goal-c').value = goals.c;
            document.getElementById('goal-f').value = goals.f;
            
            document.getElementById('goal-fruits').value = goals.micro.fruits;
            document.getElementById('goal-veg').value = goals.micro.veg;
            document.getElementById('goal-legcere').value = goals.micro.legcere;
            document.getElementById('goal-calcium').value = goals.micro.calcium;
            document.getElementById('goal-nuts').value = goals.micro.nuts;
            document.getElementById('goal-water').value = goals.micro.water;
            document.getElementById('goal-fish').value = goals.fishPerWeek;
        }

        function saveSettings() {
            appState.goals.cal = parseInt(document.getElementById('goal-cal').value) || 2100;
            appState.goals.p = parseInt(document.getElementById('goal-p').value) || 78;
            appState.goals.c = parseInt(document.getElementById('goal-c').value) || 240;
            appState.goals.f = parseInt(document.getElementById('goal-f').value) || 70;
            
            appState.goals.micro.fruits = parseInt(document.getElementById('goal-fruits').value) || 2;
            appState.goals.micro.veg = parseInt(document.getElementById('goal-veg').value) || 3;
            appState.goals.micro.legcere = parseInt(document.getElementById('goal-legcere').value) || 1;
            appState.goals.micro.calcium = parseInt(document.getElementById('goal-calcium').value) || 2;
            appState.goals.micro.nuts = parseInt(document.getElementById('goal-nuts').value) || 1;
            appState.goals.micro.water = parseInt(document.getElementById('goal-water').value) || 8;
            appState.goals.fishPerWeek = parseInt(document.getElementById('goal-fish').value) || 2;
            
            saveState();
            renderMicroCheckboxes();
            renderFishCheckboxes();
            loadDay();
            
            showAlert('Objectifs sauvegard√©s avec succ√®s!', 'success');
        }

        function resetDay() {
            if (confirm(`R√©initialiser les donn√©es du ${formatDate(currentDate)}?`)) {
                delete appState.days[currentDate];
                
                const weekStart = getWeekStart(currentDate);
                if (appState.fish[weekStart]) {
                    appState.fish[weekStart] = 0;
                }
                
                saveState();
                loadDay();
                showAlert('Journ√©e r√©initialis√©e!', 'success');
            }
        }

        // Import/Export
        function exportData() {
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'suivi-nutrition.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('Donn√©es export√©es avec succ√®s!', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Validate structure
                    if (!imported.goals || !imported.days) {
                        throw new Error('Format invalide');
                    }
                    
                    appState = imported;
                    saveState();
                    loadDay();
                    renderMicroCheckboxes();
                    renderFishCheckboxes();
                    
                    showAlert('Donn√©es import√©es avec succ√®s!', 'success');
                } catch (error) {
                    showAlert('Erreur d\'import: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // Utilities
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            document.querySelector('.content').insertBefore(alert, document.querySelector('.content').firstChild);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
    </script>
    
    <!-- PWA Scripts -->
    <script>
    // Enregistrement du Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('Service Worker enregistr√©:', registration.scope);
                    
                    // V√©rifier les mises √† jour
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Erreur Service Worker:', error);
                });
        });
    }
    
    // Notification de mise √† jour
    function showUpdateNotification() {
        showAlert('Une nouvelle version est disponible! Actualisez la page.', 'success');
    }
    
    // D√©tection de l'installation PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallButton();
    });
    
    function showInstallButton() {
        if (window.matchMedia('(display-mode: standalone)').matches) {
            return;
        }
        
        const installButton = document.createElement('button');
        installButton.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            z-index: 9998;
            transition: all 0.3s ease;
        `;
        installButton.innerHTML = 'üì± Installer';
        
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installButton.remove();
                }
                deferredPrompt = null;
            }
        });
        
        document.body.appendChild(installButton);
    }
    
    // Mode offline
    window.addEventListener('online', () => console.log('En ligne'));
    window.addEventListener('offline', () => {
        showAlert('Mode hors ligne - Les donn√©es restent sauvegard√©es', 'success');
    });
    
    // Vibration pour feedback tactile
    function vibrate(pattern = [30]) {
        if ('vibrate' in navigator) {
            navigator.vibrate(pattern);
        }
    }
    
    // Ajouter vibration aux boutons
    document.addEventListener('DOMContentLoaded', () => {
        const buttons = document.querySelectorAll('.btn-primary, .preset-btn, .nav-btn');
        buttons.forEach(button => {
            button.addEventListener('click', () => vibrate());
        });
    });
    </script>
</body>
</html>
